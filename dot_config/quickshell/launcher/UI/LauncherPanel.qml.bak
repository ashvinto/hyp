import QtQuick
import QtQuick.Controls
import QtQuick.Layouts
import QtQuick.Effects
import Quickshell
import Quickshell.Wayland
import "../Services" as Services

PanelWindow {
    id: root

    anchors { top: true; bottom: true; left: true; right: true }
    color: "transparent"

    WlrLayershell.layer: WlrLayer.Overlay
    WlrLayershell.keyboardFocus: WlrKeyboardFocus.Exclusive
    WlrLayershell.namespace: "qs-launcher"

    readonly property color cBg: (typeof Services.ThemeService !== "undefined" && Services.ThemeService.backgroundDark) ? Services.ThemeService.backgroundDark : "#11111b"
    readonly property color cSurface: (typeof Services.ThemeService !== "undefined" && Services.ThemeService.surface) ? Services.ThemeService.surface : "#1e1e2e"
    readonly property color cAccent: (typeof Services.ThemeService !== "undefined" && Services.ThemeService.accent) ? Services.ThemeService.accent : "#cba6f7"
    readonly property color cText: (typeof Services.ThemeService !== "undefined" && Services.ThemeService.text) ? Services.ThemeService.text : "#cdd6f4"
    readonly property color cDim: (typeof Services.ThemeService !== "undefined" && Services.ThemeService.text_dim) ? Services.ThemeService.text_dim : "#6c7086"

    Component.onCompleted: {
        Services.AppService.scan()
        searchInput.forceActiveFocus()
    }

    property string filterText: ""
    property int scrollDir: 0

    // Enhanced Parser with Language Support
    property var commandResult: {
        if (filterText === "") return null
        
        // 1. File Search (/)
        if (filterText.startsWith("/")) return { type: "file", label: "File Search", icon: "󰈞", value: filterText.substring(1) }
        
        // 2. Multi-Lang Dictionary (def [lang:]word)
        if (filterText.startsWith("def ")) {
            var query = filterText.substring(4).trim()
            if (query) {
                Services.AppService.lookupWord(query)
                var displayLabel = query.includes(":") ? "Dictionary (" + query.split(":")[0] + ")" : "Dictionary (en)"
                return { type: "dict", label: displayLabel, icon: "", value: Services.AppService.definition || "Searching..." }
            }
        }

        // 3. Math
        if (/^[0-9+\-*/().\s]+$/.test(filterText)) {
            try {
                var res = eval(filterText)
                if (res !== undefined && res.toString() !== filterText) 
                    return { type: "math", value: res, label: "Result", icon: "󰃬" }
            } catch(e) {}
        }
        
        // 4. Shortcut
        if (filterText.toLowerCase() === "ai") return { type: "hub", label: "AI Hub", icon: "󰚩", cmd: "zero-ai" }
        
        return null
    }

    property var filteredApps: {
        var list = Services.AppService.apps
        if (filterText === "" || filterText.startsWith("/") || filterText.startsWith("def ")) return list 
        var lowerFilter = filterText.toLowerCase()
        return list.filter(app => app.name.toLowerCase().includes(lowerFilter))
    }

    function runLauncher() {
        if (commandResult) {
            if (commandResult.type === "math") Quickshell.execDetached(["sh", "-c", "printf '" + commandResult.value + "' | wl-copy"])
            else if (commandResult.type === "hub") Quickshell.execDetached(["bash", "-c", commandResult.cmd])
            Qt.quit()
            return
        }
        if (filteredApps.length > 0) Services.AppService.launch(filteredApps[0].exec)
    }

    Timer {
        id: scrollTimer; interval: 16; repeat: true; running: root.scrollDir !== 0
        onTriggered: gridView.contentY = Math.max(0, Math.min(gridView.contentHeight - gridView.height, gridView.contentY + (8 * root.scrollDir)))
    }

    Rectangle { anchors.fill: parent; color: "black"; opacity: 0.4; MouseArea { anchors.fill: parent; onClicked: Qt.quit() } }

    Rectangle {
        id: mainWindow
        anchors.centerIn: parent
        width: 1000; height: 650
        radius: 28; border.color: Qt.rgba(1, 1, 1, 0.1); border.width: 1; clip: true
        color: "#181825" 
        
        layer.enabled: true
        layer.effect: MultiEffect { shadowEnabled: true; shadowBlur: 0.6; shadowOpacity: 0.4; shadowVerticalOffset: 10 }

        ColumnLayout {
            anchors.fill: parent; anchors.margins: 25; spacing: 15

            // --- SEARCH BAR ---
            Rectangle {
                Layout.fillWidth: true; height: 52; radius: 14
                color: Qt.rgba(0,0,0,0.3); border.color: searchInput.activeFocus ? cAccent : Qt.rgba(1,1,1,0.1); border.width: 1
                RowLayout {
                    anchors.fill: parent; anchors.margins: 15; spacing: 15
                    Text { text: "󰍉"; color: cAccent; font.pixelSize: 20; font.family: "Symbols Nerd Font" }
                    TextInput {
                        id: searchInput; Layout.fillWidth: true; verticalAlignment: TextInput.AlignVCenter
                        font.pixelSize: 16; color: "white"; clip: true
                        onTextChanged: {
                            root.filterText = text
                            if (text.startsWith("/")) Services.AppService.searchFiles(text.substring(1))
                        }
                        onAccepted: runLauncher()
                        Keys.onEscapePressed: Qt.quit()
                    }
                }
            }

            // --- INLINE RESULT ---
            Rectangle {
                Layout.fillWidth: true; height: (commandResult && commandResult.type !== "file") ? 60 : 0
                radius: 14; clip: true; opacity: (commandResult && commandResult.type !== "file") ? 1 : 0
                color: Qt.rgba(cAccent.r, cAccent.g, cAccent.b, 0.12); border.color: cAccent; border.width: 1
                Behavior on height { NumberAnimation { duration: 200 } }
                Behavior on opacity { NumberAnimation { duration: 200 } }
                
                RowLayout {
                    anchors.fill: parent; anchors.margins: 15; spacing: 15
                    Text { text: commandResult ? commandResult.icon : ""; color: cAccent; font.pixelSize: 24; font.family: "Symbols Nerd Font" }
                    Text { 
                        text: commandResult ? (commandResult.label + ": " + (commandResult.value || filterText)) : ""
                        color: "white"; font.pixelSize: 13; font.bold: true; Layout.fillWidth: true; elide: Text.ElideRight 
                    }
                }
                MouseArea { anchors.fill: parent; onClicked: runLauncher() }
            }

            // --- CONTENT AREA ---
            Item {
                Layout.fillWidth: true; Layout.fillHeight: true
                
                GridView {
                    id: gridView; anchors.fill: parent; 
                    cellWidth: 135; cellHeight: 145; clip: true; focus: true
                    model: root.filteredApps; visible: !filterText.startsWith("/") && !filterText.startsWith("def ")
                    
                    highlight: Rectangle {
                        width: 115; height: 130; radius: 20
                        gradient: Gradient {
                            GradientStop { position: 0.0; color: Qt.rgba(cAccent.r, cAccent.g, cAccent.b, 0.18) }
                            GradientStop { position: 1.0; color: Qt.rgba(cAccent.r, cAccent.g, cAccent.b, 0.08) }
                        }
                        border.color: cAccent; border.width: 1
                    }
                    highlightFollowsCurrentItem: true; highlightMoveDuration: 250

                    delegate: Item {
                        width: gridView.cellWidth; height: gridView.cellHeight
                        ColumnLayout {
                            anchors.centerIn: parent; spacing: 12
                            Item {
                                Layout.alignment: Qt.AlignHCenter; width: 72; height: 72
                                Image { anchors.fill: parent; anchors.margins: 10; source: modelData.icon ? ("image://icon/" + modelData.icon) : ""; fillMode: Image.PreserveAspectFit; asynchronous: true }
                            }
                            Text { Layout.preferredWidth: 110; text: modelData.name; color: "white"; font.pixelSize: 11; horizontalAlignment: Text.AlignHCenter; elide: Text.ElideRight; maximumLineCount: 2; wrapMode: Text.WordWrap; opacity: gridView.currentIndex === index ? 1.0 : 0.7 }
                        }
                        MouseArea { 
                            anchors.fill: parent; hoverEnabled: true; onEntered: gridView.currentIndex = index; onClicked: Services.AppService.launch(modelData.exec)
                            onPositionChanged: (m) => { var gy = mapToItem(mainWindow, m.x, m.y).y; if (gy > mainWindow.height - 60) root.scrollDir = 1; else if (gy < 120) root.scrollDir = -1; else root.scrollDir = 0 }
                        }
                    }
                }

                ListView {
                    id: fileList; anchors.fill: parent; spacing: 8; clip: true; visible: filterText.startsWith("/")
                    model: Services.AppService.files
                    delegate: Rectangle {
                        width: fileList.width; height: 52; radius: 12
                        color: fHover.hovered ? Qt.rgba(255,255,255,0.05) : "transparent"
                        border.color: fHover.hovered ? cAccent : "transparent"; border.width: 1
                        RowLayout {
                            anchors.fill: parent; anchors.margins: 12; spacing: 15
                            Text { text: "󰈔"; color: cAccent; font.pixelSize: 22; font.family: "Symbols Nerd Font" }
                            ColumnLayout {
                                spacing: 0; Layout.fillWidth: true
                                Text { text: modelData.name; color: "white"; font.bold: true; font.pixelSize: 14; elide: Text.ElideRight }
                                Text { text: modelData.path; color: cDim; font.pixelSize: 9; elide: Text.ElideRight }
                            }
                        }
                        MouseArea { id: fHover; anchors.fill: parent; hoverEnabled: true; onClicked: { Quickshell.execDetached(["xdg-open", modelData.path]); Qt.quit() } }
                    }
                }
            }
        }
    }
}
